generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ==================== AUTH ====================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String?  @map("password_hash")
  name         String?
  avatarUrl    String?  @map("avatar_url")

  // OAuth identifiers
  googleId String? @unique @map("google_id")
  appleId  String? @unique @map("apple_id")

  // Status
  isVerified Boolean @default(false) @map("is_verified")
  isActive   Boolean @default(true) @map("is_active")

  // Voice settings
  voiceSettings Json? @map("voice_settings")

  // Relations
  twin          TwinProfile?
  conversations Conversation[]
  refreshTokens RefreshToken[]
  dataSources   DataSource[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("refresh_tokens")
}

// ==================== PHOTOS ====================

model Photo {
  id     String @id @default(uuid())
  userId String @map("user_id")
  twinId String @map("twin_id")

  // File info
  filename     String
  originalName String  @map("original_name")
  mimeType     String  @map("mime_type")
  size         Int

  // Analysis
  description String?
  category    String  @default("other") // selfie, friends, family, travel, food, pet, hobby, work, event, nature, other
  analysis    Json    @default("{}") // Full analysis from Gemini Vision

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([twinId])
  @@map("photos")
}

// ==================== DATA SOURCES ====================

model DataSource {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Source type: whatsapp, instagram, twitter, photos, etc.
  type   String
  name   String // Display name (e.g., "WhatsApp - John Doe")
  status DataSourceStatus @default(pending)

  // Metadata about the source
  metadata Json @default("{}") // participants, date range, etc.

  // Processing stats
  totalItems     Int @default(0) @map("total_items")
  processedItems Int @default(0) @map("processed_items")
  memoriesCreated Int @default(0) @map("memories_created")

  // Error tracking
  lastError String? @map("last_error")

  processedAt DateTime? @map("processed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([userId, type])
  @@map("data_sources")
}

enum DataSourceStatus {
  pending
  processing
  completed
  failed
}

// ==================== TWIN ====================

model TwinProfile {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personality traits (Big Five model + custom)
  personalityTraits Json @default("{}") @map("personality_traits")

  // How the twin communicates
  communicationStyle Json @default("{}") @map("communication_style")

  // User interests
  interests String[] @default([])

  // Preferences (likes, dislikes, habits)
  preferences Json @default("{}") @map("preferences")

  // Facts learned from conversations and data
  learnedFacts Json @default("[]") @map("learned_facts")

  // Analysis tracking
  lastAnalyzedAt DateTime? @map("last_analyzed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  insights  Insight[]
  memories  Memory[]
  questions TwinQuestion[]

  @@map("twin_profiles")
}

// ==================== MEMORY (Vector-enabled) ====================

model Memory {
  id     String      @id @default(uuid())
  twinId String      @map("twin_id")
  twin   TwinProfile @relation(fields: [twinId], references: [id], onDelete: Cascade)

  // Memory content
  content  String
  summary  String? // Short summary for quick reference
  category String  // fact, preference, experience, relationship, habit

  // Vector embedding for semantic search (768 dimensions for Gemini)
  embedding Unsupported("vector(768)")?

  // Metadata
  source     String? // chat, instagram, whatsapp, twitter, manual
  sourceId   String? @map("source_id") // Reference to original content
  importance Float   @default(0.5) // 0-1, how important this memory is
  accessCount Int    @default(0) @map("access_count") // How often recalled

  lastAccessedAt DateTime? @map("last_accessed_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([twinId, category])
  @@map("memories")
}

// ==================== CHAT ====================

model Conversation {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title    String?
  messages Message[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role    MessageRole
  content String

  // Vector embedding for semantic search
  embedding Unsupported("vector(768)")?

  // AI metadata
  tokenCount Int? @map("token_count")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([conversationId])
  @@map("messages")
}

enum MessageRole {
  user
  assistant
  system
}

// ==================== TWIN QUESTIONS ====================

model TwinQuestion {
  id     String      @id @default(uuid())
  twinId String      @map("twin_id")
  twin   TwinProfile @relation(fields: [twinId], references: [id], onDelete: Cascade)

  // Question details
  question String
  category String // personality, preferences, relationships, experiences, goals, daily_life
  context  String? // Why this question is being asked

  // Answer
  answer     String?
  answeredAt DateTime? @map("answered_at")

  // Status
  status QuestionStatus @default(pending)

  // Priority (higher = more important to ask)
  priority Int @default(5) // 1-10

  // Skip tracking
  skippedCount Int @default(0) @map("skipped_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([twinId, status])
  @@map("twin_questions")
}

enum QuestionStatus {
  pending
  answered
  skipped
}

// ==================== PROACTIVE MESSAGES ====================

model TwinNotification {
  id     String @id @default(uuid())
  userId String @map("user_id")

  // Message content
  type     NotificationType
  title    String
  message  String
  context  String? // Why this notification was generated

  // Status
  isRead   Boolean   @default(false) @map("is_read")
  readAt   DateTime? @map("read_at")

  // Action (optional)
  actionType String? @map("action_type") // "chat", "question", "memory", etc.
  actionData Json?   @map("action_data")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, isRead])
  @@map("twin_notifications")
}

enum NotificationType {
  greeting        // Daily greeting
  insight         // New insight discovered
  question        // Follow-up question
  reminder        // Reminder about something
  suggestion      // Suggestion or tip
  milestone       // Achievement/milestone
  check_in        // Emotional check-in
}

// ==================== INSIGHTS ====================

model Insight {
  id     String      @id @default(uuid())
  twinId String      @map("twin_id")
  twin   TwinProfile @relation(fields: [twinId], references: [id], onDelete: Cascade)

  category   String // personality, preference, behavior, memory
  key        String // e.g., "favorite_food", "morning_person"
  value      String
  confidence Float   @default(0.5) // 0-1 confidence score
  source     String? // "chat", "instagram", "whatsapp"

  // Vector embedding for semantic similarity
  embedding Unsupported("vector(768)")?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([twinId, category])
  @@map("insights")
}
